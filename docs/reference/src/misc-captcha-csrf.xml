<chapter id="misc-captcha-csrf">
	<title>验证码和防跨站点引用攻击</title>
	<para>
		<programlisting>
		<![CDATA[
			@InputConfig(resultName = "forgot")
			@Captcha(always = true)
			@Validations(requiredStrings = { @RequiredStringValidator(type = ValidatorType.FIELD, fieldName = "user.email", trim = true, key = "validation.required") }, emails = { @EmailValidator(type = ValidatorType.FIELD, fieldName = "user.email", key = "validation.invalid") })
			public String forgot() {
				User user = userManager.getByEmail(email);
				if (user == null) {
					addActionError(getText("validation.not.exists"));
				} else {
					password = CodecUtils.randomString(10);
					user.setLegiblePassword(password);
					userManager.save(user);
					user.setPassword(password);
					Map<String, Object> model = new HashMap<String, Object>();
					model.put("user", user);
					model.put("url", "/account/manage?tab=password");
					SimpleMailMessage smm = new SimpleMailMessage();
					smm.setTo(user.getFriendlyName() + "<" + user.getEmail() + ">");
					smm.setSubject("this is your username and password");
					mailService.send(smm, "template/account_forgot.ftl", model);
					addActionMessage(getText("operate.success"));
				}
				return "forgot";
			}
		]]>
		</programlisting>
		<programlisting>
		<![CDATA[		
<@s.form method="post" cssClass="ajax reset">
			<@s.textfield label="%{getText('email')}" name="account.email" cssClass="required email"/>
			<@captcha/>
			<@s.submit value="%{getText('confirm')}"/>
</@s.form>
		]]>
		</programlisting>
		<table>
			<title>@Captcha的属性</title>
			<tgroup cols="2">
				<colspec colname="c1" colwidth="3*" />
				<colspec colname="c2" colwidth="5*" />
				<thead>
					<row>
						<entry>属性</entry>
						<entry>说明</entry>
					</row>
				</thead>
				<tbody>
					<row>
						<entry>
							<literal>always</literal>
						</entry>
						<entry>
								如果true则每次都需要输入
						</entry>
					</row>
					<row>
						<entry>
							<literal>threshold</literal>
						</entry>
						<entry>
								阀值,错误次数超过这个则弹出验证码
						</entry>
					</row>
					<row>
						<entry>
							<literal>bypassLoggedInUser</literal>
						</entry>
						<entry>
								登录用户不需要输入
						</entry>
					</row>
				</tbody>
			</tgroup>
		</table>
	</para>
	<para>
		防止跨站点引用攻击只需在action的方法上面打@Csrf
	</para>
</chapter>


